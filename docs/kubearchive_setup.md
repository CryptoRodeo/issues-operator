# Setting up Issues Operator to work with KubeArchive

The Prereqs for KubeArchive are:
- A PostgreSQL instance (+v16.6) protected with TLS (can be self-signed, KubeArchive does not verify it)
- CertManager is installed on the Kubernetes cluster (+v1.17.2)
- Knative Eventing is installed on the Kubernetes cluster (+v1.17.4)

This guide will help sets those up. This is strictly for dev envs.

## PostgreSQL setup:

---

### Prerequisites

* You have `kubectl` access to your cluster.
* You have `helm` installed (`brew install helm` or see [helm.sh](https://helm.sh/docs/intro/install/)).

---

### Step-by-step: Install PostgreSQL in the `kubearchive` namespace

#### 1. Create namespace (if not already created)

```bash
kubectl create namespace kubearchive
```

---

#### 2. Add Bitnami Helm repo (if not already added)

```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
```

---

#### 3. Install PostgreSQL into the cluster
Create a `psql.yaml` file to enable self-signed SSL in the DB:
```yaml
image:
  repository: bitnami/postgresql
  tag: latest
  pullPolicy: IfNotPresent

auth:
  username: kubearchive
  password: Databas3Passw0rd
  database: kubearchive

tls:
  enabled: true
  autoGenerated: true  # Let Bitnami auto-generate self-signed certs

primary:
  extraFlags: "-c ssl=on -c ssl_cert_file=/opt/bitnami/postgresql/certs/tls.crt -c ssl_key_file=/opt/bitnami/postgresql/certs/tls.key"

```
Then install the DB
```bash
helm install kubearchive-postgresql bitnami/postgresql \
  -n kubearchive -f pg-ssl-values.yaml
```

This will:

* Create a StatefulSet running PostgreSQL
* Create a service you can use as the DB hostname
* Use default port `5432`
* Enable SSL
* Set up:

  * `username`: `kubearchive`
  * `password`: `Databas3Passw0rd`
  * `database`: `kubearchive`

---

## Set up KNative eventing

### 1. Install Knative Eventing
If not already installed, run:
```bash
kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.13.3/eventing-crds.yaml
kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.13.3/eventing-core.yaml
```
To install the default `MTChannelBasedBroker` ( using in-memory channel):
```bash
kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.13.3/in-memory-channel.yaml
kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.13.3/mt-channel-broker.yaml
```

Replace the version with a newer one if needed: https://github.com/knative/eventing/releases

---

### 2. Enable Automatic Broker Creation

```bash
kubectl label namespace kubearchive knative-eventing-injection=enabled
```

If that doesn't work, manually create the broker (`broker.yaml`):
```yaml
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: kubearchive-broker
  namespace: kubearchive
```

Apply it:
```bash
kubectl apply -f broker.yaml
```

---

## Set up Cert-Manager

### 1. Install
Apply the official YAMLS (latest version from Jetstack):
```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.3/cert-manager.yaml
```

Latest versions can be found here: https://github.com/cert-manager/cert-manager/releases

This will create:
- The `cert-manager` namespace
- Deployments for `cert-manager`, `cert-manager-cainjector`, and `cert-manager-webhook`
- Required CRDs (`Certificate`, `Issuer`, etc.)

---

### 2. Wait for Pods to be ready
```bash
kubectl get pods -n cert-manager
```

You should see:
```bash
cert-manager-xxxxxx        Running
cert-manager-cainjector    Running
cert-manager-webhook       Running
```
Cert manager should be ready now.

---

## Set up KubeArchive
Follow these instructions: https://kubearchive.github.io/kubearchive/main/getting-started/installation.html#_prepare_the_database

---

### 1. Preparing the DB
You can use this:

```bash
migrate \
  -verbose -path integrations/database/postgresql/migrations/ \
  -database "postgresql://kubearchive:Databas3Passw0rd@kubearchive-postgresql.kubearchive.svc.cluster.local:5432/kubearchive?sslmode=require" \
  up
```

---

### 2. DB Secrets patch

```bash
kubectl patch secret -n kubearchive kubearchive-database-credentials \
  --patch='{"stringData": {
  "DATABASE_URL": "kubearchive-postgresql.kubearchive.svc.cluster.local", 
  "DATABASE_PASSWORD": "Databas3Passw0rd" 
}}'
```
---

### 3. Restart deployments
```bash
kubectl rollout -n kubearchive restart deployment kubearchive-sink kubearchive-api-server
```
---

#### Verify it's working:

Check the logs again:

```bash
kubectl logs deploy/kubearchive-api-server -n kubearchive
```
---
